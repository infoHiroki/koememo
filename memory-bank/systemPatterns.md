# システムパターン

## アーキテクチャ概要

KoeMemoは以下の主要コンポーネントから構成されるシンプルなアーキテクチャを採用しています：

```
┌──────────────────┐    ┌─────────────────┐    ┌───────────────┐
│  ファイル監視    │───>│  文字起こし     │───>│  LLM処理      │
│  (Watchdog)      │    │  (Whisper)      │    │  (API連携)    │
└──────────────────┘    └─────────────────┘    └───────────────┘
         │                                             │
         │                                             ▼
┌──────────────────┐                         ┌───────────────┐
│  GUI設定画面     │<────────────────────────│  出力生成     │
│  (Tkinter)       │                         │  (ファイル保存)│
└──────────────────┘                         └───────────────┘
```

## 主要コンポーネント

### 1. ファイル監視システム
- **技術**: Watchdogライブラリ
- **責任**: 指定フォルダの監視、新規ファイルの検出、処理キューへの追加
- **実装**: `MediaFileHandler`クラスがファイル作成イベントを処理

### 2. 文字起こしエンジン
- **技術**: Faster Whisperモデル
- **責任**: 音声・動画ファイルのテキスト変換
- **実装**: `transcribe_file`関数が文字起こし処理を実行

### 3. LLM連携システム
- **技術**: REST API（各種LLMプロバイダー）
- **責任**: 文字起こしテキストの送信、AI処理、議事録の取得
- **実装**: `call_llm_api`が適切なプロバイダー関数を呼び出し

### 4. 出力生成
- **技術**: ファイル操作
- **責任**: 生成された議事録の保存、処理履歴の管理
- **実装**: `save_output`関数とprocessed_files管理

### 5. 設定GUI
- **技術**: Tkinter
- **責任**: ユーザー設定の管理、サービス制御、ログ表示
- **実装**: `KoeMemoGUI`クラスがUI要素を提供

## 主要なデータフロー

1. **ファイル検出**: 監視フォルダ内の新規ファイルが検出される
2. **キュー登録**: 検出されたファイルが処理キューに追加される
3. **文字起こし**: キューからファイルが取り出され、文字起こしが実行される
4. **LLM送信**: 文字起こしテキストが選択されたLLMに送信される
5. **議事録生成**: LLMの応答から構造化された議事録が生成される
6. **結果保存**: 生成された議事録が出力フォルダに保存される
7. **処理記録**: 処理済みファイルのハッシュと出力パスが記録される

## 設計パターン

### イベント駆動型アーキテクチャ
- ファイル監視がイベントベースで処理を開始する非同期設計
- `Observer`パターンを活用したイベントハンドリング

### プロデューサー・コンシューマーパターン
- ファイル検出（プロデューサー）と処理スレッド（コンシューマー）の分離
- キューを介した非同期処理によるパフォーマンス向上

### 戦略パターン
- LLMプロバイダー選択による異なるAPI呼び出し戦略
- 文字起こしモデルサイズ選択による性能調整戦略

### シングルトンパターン
- 設定情報へのグローバルアクセス
- アプリケーション全体で共有されるリソース管理

## 重要な実装パス

1. **サービス起動フロー**:
   - `main()` → `start_service()` → `start_file_watcher()` + `process_file_queue()`

2. **ファイル処理フロー**:
   - `MediaFileHandler.on_created()` → キュー追加 → `process_file_queue()` → `transcribe_file()` → `call_llm_api()` → `save_output()`

3. **設定管理フロー**:
   - `KoeMemoGUI` → 設定更新 → `save_config()` → サービス再起動

## 依存関係管理

KoeMemoは以下の外部依存関係を持ちます：

1. **Pythonコアライブラリ**: os, sys, json, threading, logging等
2. **Faster Whisper**: 文字起こしモデル実装
3. **Requests**: HTTP APIリクエスト処理
4. **Watchdog**: ファイル監視システム
5. **Tkinter**: GUIフレームワーク

これらの依存関係は明示的にインポートされ、不足している場合はインストール指示が表示されます。 